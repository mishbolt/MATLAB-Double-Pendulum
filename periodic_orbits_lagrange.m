
clc
clear all

x0 = [3.65430199670189e-16;4.44089209850063e-16;0.205718913883074;0.250000000000000];
T0 = [8.23741497068322];
N = 1;
err = 1;

func = (f(T0,x0))';


while err>=1e-5 % WHILE abs(f(x)-x)>tol
    
    velocity = -der(func(:,end));
    jacobian = J(T0,x0);
    jacobian(:,2) = zeros(4,1);
    jacobian(:,4) = zeros(4,1);
    A = [eye(4)-jacobian,-der(func(:,end));
        der(func(:,end))',               0];
        
    
    
    Y = -[x0-(func(:,end))  ;0];
    
    
    XT = A\Y;
    
  [Eigv, Eig] = eig(J(T0,x0));
    
   x0 = x0+XT(1:4);
   T0 = T0+XT(5);
   
   
    func = (f(T0,x0))';
    
    err = abs(func(:,end)-x0);
    err = norm(err);
    N = N+1;
    
end

perorb = f(T0,x0);

det(J(T0,x0))


function x = f(t,x0)

options = [];

[~,x] = ode45(@derivative,[0,t],x0,options);


end

function dxdt = derivative(t,X)
mu = 1;
lam = 1;

dxdt1 = X(3);
dxdt2 = X(4);
A = (1/lam*sin(X(2))*cos(X(1)-X(2))-(X(3))^2*sin(2*(X(1)-X(2)))-(X(4))^2*...
    sin(X(1)-X(2))*lam-lam*(mu+1)*sin(X(1)))/(lam^2*(mu+1)-(cos(X(1)-X(2)))^2);

dxdt3 = A;
dxdt4 = (-1/lam*sin(X(2))-A*cos(X(1)-X(2))+(X(3))^2*sin(X(1)-X(2)))/lam;


dxdt = [dxdt1;dxdt2;dxdt3;dxdt4];



end

function dxdt = der(X)
mu = 1;
lam = 1;

dxdt1 = X(3);
dxdt2 = X(4);
A = (1/lam*sin(X(2))*cos(X(1)-X(2))-(X(3))^2*sin(2*(X(1)-X(2)))-(X(4))^2*...
    sin(X(1)-X(2))*lam-lam*(mu+1)*sin(X(1)))/(lam^2*(mu+1)-(cos(X(1)-X(2)))^2);

dxdt3 = A;
dxdt4 = (-1/lam*sin(X(2))-A*cos(X(1)-X(2))+(X(3))^2*sin(X(1)-X(2)))/lam;


dxdt = [dxdt1;dxdt2;dxdt3;dxdt4];

end


function A = stab(X)
mu = 1;
lam = 1;

A(1,:) = [0,0,1,0];

A(2,:) = [0,0,0,1];

A(3,1) = [2.*lam.^(-1).*cos(X(1)+(-1).*X(2)).*(1+mu+(-1).*cos(X(1)+(-1).*X(2)).^2) ...
  .^(-2).*sin(X(1)+(-1).*X(2)).*(sin(X(1))+mu.*sin(X(1))+X(4).^2.*sin(X(1)+(-1) ...
  .*X(2))+lam.*X(3).^2.*cos(X(1)+(-1).*X(2)).*sin(X(1)+(-1).*X(2))+(-1).*cos(X(1)+ ...
  (-1).*X(2)).*sin(X(2)))+(-1).*lam.^(-1).*(1+mu+(-1).*cos(X(1)+(-1).*X(2)) ...
  .^2).^(-1).*(cos(X(1))+mu.*cos(X(1))+X(4).^2.*cos(X(1)+(-1).*X(2))+lam.* ...
  X(3).^2.*cos(X(1)+(-1).*X(2)).^2+(-1).*lam.*X(3).^2.*sin(X(1)+(-1).*X(2)).^2+ ...
  sin(X(1)+(-1).*X(2)).*sin(X(2)))];

A(3,2) = [(-2).*lam.^(-1).*cos(X(1)+(-1).*X(2)).*(1+mu+(-1).*cos(X(1)+(-1).*X(2)) ...
  .^2).^(-2).*sin(X(1)+(-1).*X(2)).*(sin(X(1))+mu.*sin(X(1))+X(4).^2.*sin(X(1)+( ...
  -1).*X(2))+lam.*X(3).^2.*cos(X(1)+(-1).*X(2)).*sin(X(1)+(-1).*X(2))+(-1).*cos( ...
  X(1)+(-1).*X(2)).*sin(X(2)))+(-1).*lam.^(-1).*(1+mu+(-1).*cos(X(1)+(-1).* ...
  X(2)).^2).^(-1).*((-1).*X(4).^2.*cos(X(1)+(-1).*X(2))+(-1).*lam.*X(3).^2.* ...
  cos(X(1)+(-1).*X(2)).^2+(-1).*cos(X(1)+(-1).*X(2)).*cos(X(2))+lam.*X(3).^2.* ...
  sin(X(1)+(-1).*X(2)).^2+(-1).*sin(X(1)+(-1).*X(2)).*sin(X(2)))];

A(3,3) = [(-2).*X(3).*cos(X(1)+(-1).*X(2)).*(1+mu+(-1).*cos(X(1)+(-1).*X(2)).^2).^( ...
  -1).*sin(X(1)+(-1).*X(2))];

A(3,4) = [(-2).*lam.^(-1).*X(4).*(1+mu+(-1).*cos(X(1)+(-1).*X(2)).^2).^(-1).*sin( ...
  X(1)+(-1).*X(2))];

A(4,1) = [(-1).*((-1)+(-1).*mu+cos(X(1)+(-1).*X(2)).^2).^(-1).*(lam.*X(3).^2.* ...
  cos(X(1)+(-1).*X(2))+lam.*mu.*X(3).^2.*cos(X(1)+(-1).*X(2))+cos(X(1)).*cos(X(1)+ ...
  (-1).*X(2))+mu.*cos(X(1)).*cos(X(1)+(-1).*X(2))+X(4).^2.*cos(X(1)+(-1).*X(2)) ...
  .^2+(-1).*sin(X(1)).*sin(X(1)+(-1).*X(2))+(-1).*mu.*sin(X(1)).*sin(X(1)+(-1) ...
  .*X(2))+(-1).*X(4).^2.*sin(X(1)+(-1).*X(2)).^2)+(-2).*cos(X(1)+(-1).*X(2)).*(( ...
  -1)+(-1).*mu+cos(X(1)+(-1).*X(2)).^2).^(-2).*sin(X(1)+(-1).*X(2)).*(cos( ...
  X(1)+(-1).*X(2)).*sin(X(1))+mu.*cos(X(1)+(-1).*X(2)).*sin(X(1))+lam.*X(3).^2.* ...
  sin(X(1)+(-1).*X(2))+lam.*mu.*X(3).^2.*sin(X(1)+(-1).*X(2))+X(4).^2.*cos(X(1)+( ...
  -1).*X(2)).*sin(X(1)+(-1).*X(2))+(-1).*sin(X(2))+(-1).*mu.*sin(X(2)))];

A(4,2) = [(-1).*((-1)+(-1).*mu+cos(X(1)+(-1).*X(2)).^2).^(-1).*((-1).*lam.* ...
  X(3).^2.*cos(X(1)+(-1).*X(2))+(-1).*lam.*mu.*X(3).^2.*cos(X(1)+(-1).*X(2))+( ...
  -1).*X(4).^2.*cos(X(1)+(-1).*X(2)).^2+(-1).*cos(X(2))+(-1).*mu.*cos(X(2))+ ...
  sin(X(1)).*sin(X(1)+(-1).*X(2))+mu.*sin(X(1)).*sin(X(1)+(-1).*X(2))+X(4).^2.* ...
  sin(X(1)+(-1).*X(2)).^2)+2.*cos(X(1)+(-1).*X(2)).*((-1)+(-1).*mu+cos(X(1)+( ...
  -1).*X(2)).^2).^(-2).*sin(X(1)+(-1).*X(2)).*(cos(X(1)+(-1).*X(2)).*sin(X(1))+ ...
  mu.*cos(X(1)+(-1).*X(2)).*sin(X(1))+lam.*X(3).^2.*sin(X(1)+(-1).*X(2))+lam.* ...
  mu.*X(3).^2.*sin(X(1)+(-1).*X(2))+X(4).^2.*cos(X(1)+(-1).*X(2)).*sin(X(1)+(-1).* ...
  X(2))+(-1).*sin(X(2))+(-1).*mu.*sin(X(2)))];

A(4,3) = [(-1).*((-1)+(-1).*mu+cos(X(1)+(-1).*X(2)).^2).^(-1).*(2.*lam.*X(3).* ...
  sin(X(1)+(-1).*X(2))+2.*lam.*mu.*X(3).*sin(X(1)+(-1).*X(2)))];

A(4,4) = [(-2).*X(4).*cos(X(1)+(-1).*X(2)).*((-1)+(-1).*mu+cos(X(1)+(-1).*X(2)).^2) ...
  .^(-1).*sin(X(1)+(-1).*X(2))];


end



function jacobian = J(t,X)

A = stab(X);


jac0 = [1;0;0;0;0;1;0;0;0;0;1;0;0;0;0;1];
options = [];

[~,jac] = ode45(@diffjac,[0,t],jac0,options,A);


 jac = jac(end,:)';
 jacobian = zeros(4,4);

 for i = 1:4

 jacobian(i,1:4) = jac((4*i-3):4*i);
 
 end


end


function jacobian = diffjac(t,X,A)


jacobian = [A(1,1)...
    *X(1)+A(1,2)*X(5)+A(1,3)*X(9)+A(1,4)*X(13);
    A(1,1)*X(2)+A(1,2)*X(6)+A(1,3)*X(10)+A(1,4)*X(14);
    A(1,1)*X(3)+A(1,2)*X(7)+A(1,3)*X(11)+A(1,4)*X(15);
    A(1,1)*X(4)+A(1,2)*X(8)+A(1,3)*X(12)+A(1,4)*X(16);
    A(2,1)*X(1)+A(2,2)*X(5)+A(2,3)*X(9)+A(2,4)*X(13);
    A(2,1)*X(2)+A(2,2)*X(6)+A(2,3)*X(10)+A(2,4)*X(14);
    A(2,1)*X(3)+A(2,2)*X(7)+A(2,3)*X(11)+A(2,4)*X(15);
    A(2,1)*X(4)+A(2,2)*X(8)+A(2,3)*X(12)+A(2,4)*X(16);
    A(3,1)*X(1)+A(3,2)*X(5)+A(3,3)*X(9)+A(3,4)*X(13);
    A(3,1)*X(2)+A(3,2)*X(6)+A(3,3)*X(10)+A(3,4)*X(14);
    A(3,1)*X(3)+A(3,2)*X(7)+A(3,3)*X(11)+A(3,4)*X(15);
    A(3,1)*X(4)+A(3,2)*X(8)+A(3,3)*X(12)+A(3,4)*X(16);
    A(4,1)*X(1)+A(4,2)*X(5)+A(4,3)*X(9)+A(4,4)*X(13);
    A(4,1)*X(2)+A(4,2)*X(6)+A(4,3)*X(10)+A(4,4)*X(14);
    A(4,1)*X(3)+A(4,2)*X(7)+A(4,3)*X(11)+A(4,4)*X(15);
    A(4,1)*X(4)+A(4,2)*X(8)+A(4,3)*X(12)+A(4,4)*X(16);];




end




